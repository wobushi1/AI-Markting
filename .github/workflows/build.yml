name: Build EXE

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1️⃣ 检出代码
    - uses: actions/checkout@v4

    # 2️⃣ 安装 Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # 3️⃣ 下载 Poppler
    - name: Download Poppler
      shell: powershell
      run: |
        Write-Host "Downloading Poppler..."
        Invoke-WebRequest -Uri https://github.com/oschwartz10612/poppler-windows/releases/download/v25.11.0-0/Release-25.11.0-0.zip -OutFile poppler.zip
        Expand-Archive -Path poppler.zip -DestinationPath temp_poppler

    # 4️⃣ 调整 Poppler 目录结构
    - name: Prepare Poppler folder
      shell: powershell
      run: |
        # 如果里面有 Release-25.11.0-0 文件夹，把内容移到 poppler 下
        if (Test-Path "temp_poppler/Release-25.11.0-0") {
            Remove-Item -Recurse -Force poppler -ErrorAction SilentlyContinue
            Rename-Item -Path "temp_poppler/Release-25.11.0-0" -NewName "poppler"
        } else {
            # 如果没有 Release-25.11.0-0，直接重命名 temp_poppler 为 poppler
            Remove-Item -Recurse -Force poppler -ErrorAction SilentlyContinue
            Rename-Item -Path temp_poppler -NewName poppler
        }

    # 5️⃣ 查看 Poppler 文件结构（调试用，可删除）
    - name: List Poppler folder
      shell: powershell
      run: Get-ChildItem -Recurse poppler

    # 6️⃣ 安装 Python 依赖
    - name: Install Dependencies
      run: |
        pip install pyinstaller PyQt5 pdf2image requests openai Pillow python-docx

    # 7️⃣ 使用 PyInstaller 打包
    - name: Build with PyInstaller
      run: |
        # 把整个 poppler 文件夹添加到 exe 中
        pyinstaller --noconsole --onefile --name="EssayGrader" --add-data "poppler;poppler" main.py

    # 8️⃣ 上传生成的 exe
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: EssayGrader-Windows
        path: dist/EssayGrader.exe
